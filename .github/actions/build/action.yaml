name: Build Logitech Media Server
description: Build Logitech Media Server with the given parameters
inputs:
  build-params:
    description: Parameters needed to run the `buildme.pl` script
    required: true
    default: ubuntu-latest
  build-type:
    description: "`nightly` or `production`"
    required: true
    default: nightly

runs:
  using: composite
  steps:
    - name: Get LMS version number
      shell: bash
      id: preparation
      run: |
        MAJOR=$(grep "\$VERSION" server/slimserver.pl | head -n1 | cut -d"'" -f2 | cut -d. -f1)
        MINOR=$(grep "\$VERSION" server/slimserver.pl | head -n1 | cut -d"'" -f2 | cut -d. -f2)

        echo "LMS_VERSION=public/$MAJOR.$MINOR" >> $GITHUB_OUTPUT

    - name: Check out LMS platform code
      uses: actions/checkout@v3
      with:
        repository: Logitech/slimserver-platforms
        path: platforms
        ref: ${{ steps.preparation.outputs.LMS_VERSION }}

    - name: Build ${{ inputs.build-params }} package
      shell: bash
      run: |
        SRC_PATH=$GITHUB_WORKSPACE

        if [ "$RUNNER_OS" == "Windows" ]; then
          SRC_PATH=$(cygpath $SRC_PATH)
        fi

        BUILD_PATH=$SRC_PATH/work
        DEST_PATH=$SRC_PATH/publish

        mkdir -p $BUILD_PATH
        mkdir -p $DEST_PATH

        platforms/buildme.pl --build ${{ inputs.build-params }} --buildDir $BUILD_PATH --sourceDir $SRC_PATH --destDir $DEST_PATH --releaseType ${{ inputs.build-type }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        path: publish
